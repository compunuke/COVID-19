<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
        <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
        <script>
            var data = [];
            var newRow = [];
            var states = {};
            var stats = [];
            var abbrevs = { "AL": "Alabama", "AK": "Alaska", "AS": "American Samoa", "AZ": "Arizona", "AR": "Arkansas", "CA": "California", "CO": "Colorado", "CT": "Connecticut", "DE": "Delaware", "DC": "District Of Columbia", "FM": "Federated States Of Micronesia", "FL": "Florida", "GA": "Georgia", "GU": "Guam", "HI": "Hawaii", "ID": "Idaho", "IL": "Illinois", "IN": "Indiana", "IA": "Iowa", "KS": "Kansas", "KY": "Kentucky", "LA": "Louisiana", "ME": "Maine", "MH": "Marshall Islands", "MD": "Maryland", "MA": "Massachusetts", "MI": "Michigan", "MN": "Minnesota", "MS": "Mississippi", "MO": "Missouri", "MT": "Montana", "NE": "Nebraska", "NV": "Nevada", "NH": "New Hampshire", "NJ": "New Jersey", "NM": "New Mexico", "NY": "New York", "NC": "North Carolina", "ND": "North Dakota", "MP": "Northern Mariana Islands", "OH": "Ohio", "OK": "Oklahoma", "OR": "Oregon", "PW": "Palau", "PA": "Pennsylvania", "PR": "Puerto Rico", "RI": "Rhode Island", "SC": "South Carolina", "SD": "South Dakota", "TN": "Tennessee", "TX": "Texas", "UT": "Utah", "VT": "Vermont", "VI": "Virgin Islands", "VA": "Virginia", "VI": "Virgin Islands", "WA": "Washington", "WV": "West Virginia", "WI": "Wisconsin", "WY": "Wyoming"};
            sum_x = sum_x2 = sum_y = sum_xy = 0;
            hist_days = 14;

//            data = $.getJSON("./daily.json", function (inFile) {
            data = $.getJSON("https://covidtracking.com/api/v1/states/daily.json", function (inFile) {
                data = inFile;
                data.forEach(obj => {
                    if (!['AS', 'GU', 'MH', 'MP', 'VI'].includes(obj.state)) {
                        if (!Object.keys(states).includes(obj.state)) {
                            states[obj.state] = [];
                        }
                        newRow = [obj.date, obj.positiveIncrease, obj.totalTestResultsIncrease];
                        states[obj.state].push(newRow);
                    }
                });
                process( states );
            });

            function process( states ) {
                Object.keys(states).forEach(state => {
                    if (states[state].length >= hist_days) {
                        sum_x = sum_x2 = sum_y = sum_tri = sum_xy = 0;
                        for (i =0; i < hist_days; i++) {
                            //get values for least squares calculation
                            //normalize each positiveIncrease to a percent of the range between smallest and largest
                            y = states[state][hist_days - i - 1][1];
                            tri = states[state][hist_days - i - 1][2];
                            sum_tri = sum_tri + tri;
                            sum_y = sum_y + y;
                            sum_x = sum_x + hist_days - i - 1;
                            sum_x2 = sum_x2 + i**2;
                            sum_xy = sum_xy + i * y;
//                            console.log (state, i, y, i**2, i * y);
                        }
                        slope = ( hist_days * sum_xy - sum_x * sum_y ) / ( hist_days * sum_x2 - sum_x**2 );
                        y_intercept = ( sum_y - slope * sum_x ) / hist_days;
                        delta = hist_days * slope;
                        slope_pct = delta / sum_tri * 100;
                        stats.push({"state": state, "slope": slope, "slope_pct": slope_pct, "y_intercept": y_intercept, "delta": delta, "sum_y": sum_y});
//                        console.log( state + "\t" + slope.toFixed(2) + "\t" + y_intercept.toFixed(2) + "\t" + delta.toFixed(2) + "\t" + sum_y.toFixed(0) + "\t" + slope_pct.toFixed(2) );
                    }
                });
                graph();
            };

            function graph() {
                var xVals = [];
                var yVals = [];
                var labels = [];
                var data = [];
                var trace1 = {};
                var trace2 = {};
                var layout = {};
                //sort states by slope_pct, lowest to highest slope
                stats.sort(function(a, b){return a.slope_pct - b.slope_pct});

                for (i = 0; i < stats.length; i++) {
                    xVals.push(stats[i].state);
                    yVals.push(stats[i].slope_pct);
                    labels.push("slope: " + stats[i].slope.toFixed(2));
                };

                trace1 = {
                    x: xVals,
                    y: yVals,
                    text: labels,
                    mode: 'lines'
                };
                var myPlot = document.getElementById('rankOrder'),
                    data = [ trace1 ],
                    layout = {
                        title:"States' Daily Cases 'Least Squares Fit' Trend, Best Decline to Worst Growth of New Cases<br>",
                        margin: {t:50, b:20, l:50},
                        height: 200,
                        width: 1600
                    };

                Plotly.newPlot('rankOrder', data, layout);
                myPlot.on('plotly_click', function(){
                    state = arguments[0].points[0].x; //state value from upper chart that was clicked
                    i=0;
                    while (stats[i].state != state) {i++}; //find the state choice
                    if (i > stats.length - 3) {i = stats.length - 3}; //don't have two states to the right of choice
                    if (i < 2) {i = 2}; //put chosen state in the middle unless state was left most
                    dotPlot(stats[i - 2].state, "plot1");
                    dotPlot(stats[i - 1].state, "plot2");
                    dotPlot(stats[i].state,     "plot3");
                    dotPlot(stats[i + 1].state, "plot4");
                    dotPlot(stats[i + 2].state, "plot5");
                });

                dotPlot(stats[0].state, "plot1");
                dotPlot(stats[1].state, "plot2");
                dotPlot(stats[2].state, "plot3");
                dotPlot(stats[3].state, "plot4");
                dotPlot(stats[4].state, "plot5");

                note = '<font color="red"><b>Click along the line above to center the graphs below on the selected State</font></b><p>';
                note = note + "States are ordered by the normalized slope of the trend line for their daily new positive cases. ";
                note = note + "The y-axis shows the trend linear change in positive cases for the period divided by each State's cumulative number of tests [pos and neg] over the period.<br>";
                note = note + "The actual linear slope [daily rise/fall] appears as a tool tip.  No conclusions can be drawn about untested individuals, so State population is not relevant.<br>";
                document.getElementById("notes1").innerHTML = note;

            }


            function dotPlot(state, plot) {
                xVals = [];
                yVals = [];
                var i = 0;
                if ( states[state].length < hist_days ) {
                    hist_days = states[state].length;
                }
//                for (i = hist_days - 1; i >= 0; i--) {
                for (i = 0; i < hist_days; i++) {
                    xVals.push(states[state][hist_days - i - 1][0].toString().substr(-4)); //date
                    yVals.push(states[state][hist_days - i - 1][1]); //pos cases
//                    console.log(i,states[state][hist_days - i - 1][1]);
                };
//                console.log(xVals, yVals);

                trace1 = {
                    x: xVals,
                    y: yVals,
                    mode: 'markers'
                };

                var which = $.grep(stats, function(obj){return obj.state === state;});
                trace2 = {
                    x: [xVals[0], xVals[xVals.length - 1]],
                    y: [which[0].y_intercept, which[0].y_intercept + hist_days * which[0].slope],
                    mode: 'lines'
                }

                data = [ trace1, trace2 ];

                layout = {
                    xaxis: {type: "category" },
                    title: `${state}, new cases per day`,
                    showlegend: false,
                    margin: {t:50, b:50, l:50, r:0},
//                    autosize: false,
                    height: 200, 
                    width: 300
                };

                Plotly.newPlot(plot, data, layout);
            }
        </script>
    </head>
    <body>
        <div id="rankOrder"></div><br>
        <div id = "notes1"></div>
        <table><tr>
            <td><div id='plot1'></div>
            <td><div id='plot2'></div>
            <td><div id='plot3'></div>
            <td><div id='plot4'></div>
            <td><div id='plot5'></div>
                        </tr></table>
    <script>
    </script>
    </body>
</html>